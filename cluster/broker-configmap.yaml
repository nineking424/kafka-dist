apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-external-ips
  namespace: kafka
data:
  kafka-broker-0: "192.168.3.14"
  kafka-broker-1: "192.168.3.15"
  kafka-broker-2: "192.168.3.16"
  
---
# ConfigMap for Kafka Broker configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-broker-config
  namespace: kafka
data:
  # Base properties template for brokers
  broker-base.properties: |
    # Basic broker properties
    process.roles=broker
    controller.listener.names=CONTROLLER
    listener.security.protocol.map=CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
    inter.broker.listener.name=INTERNAL
    log.dirs=/var/lib/kafka/data

    # Replication settings
    offsets.topic.replication.factor=3
    transaction.state.log.replication.factor=3
    transaction.state.log.min.isr=2
    default.replication.factor=3
    min.insync.replicas=2
    group.initial.rebalance.delay.ms=0

    # Cluster configuration
    controller.quorum.voters=0@kafka-controller-0.kafka-controller:29093,1@kafka-controller-1.kafka-controller:29093,2@kafka-controller-2.kafka-controller:29093

  # Script to generate final broker configuration
  generate-broker-config.sh: |
    #!/bin/bash
    set -e

    # Calculate NODE_ID based on pod ordinal (add 3 for brokers)
    NODE_ID=$((${HOSTNAME##*-} + 3))
    echo "Generating broker configuration for NODE_ID=$NODE_ID"

    # Set dynamic advertised listeners
    # ADVERTISED_LISTENERS="EXTERNAL://${HOSTNAME}.kafka-broker:9092,INTERNAL://${HOSTNAME}.kafka-broker:19092"
    EXTERNAL_IP=$(cat /config/external-ips/${HOSTNAME})
    ADVERTISED_LISTENERS="EXTERNAL://${EXTERNAL_IP}:9092,INTERNAL://${HOSTNAME}.kafka-broker:19092"

    # Copy base properties
    cp /config/broker-base.properties /shared/broker.properties

    # Add dynamic properties
    cat >> /shared/broker.properties <<EOF

    # Dynamic properties (generated at runtime)
    node.id=$NODE_ID
    listeners=EXTERNAL://:9092,INTERNAL://:19092
    advertised.listeners=$ADVERTISED_LISTENERS
    EOF

    echo "Configuration generated successfully at /shared/broker.properties"
    echo "NODE_ID: $NODE_ID"
    echo "ADVERTISED_LISTENERS: $ADVERTISED_LISTENERS"

    # Clean up stale lock file if exists
    if [ -f /var/lib/kafka/data/.lock ]; then
      echo "Removing stale lock file..."
      rm -f /var/lib/kafka/data/.lock
    fi

    # Format storage if needed
    if [ ! -f /var/lib/kafka/data/meta.properties ]; then
      echo "Formatting storage with cluster ID: ${CLUSTER_ID}"
      /opt/kafka/bin/kafka-storage.sh format -t ${CLUSTER_ID} -c /shared/broker.properties --ignore-formatted
    else
      echo "Storage already formatted, skipping..."
    fi